"""–õ–æ–≥–∏–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–≤—Ö–æ–¥–∞."""

import json
import secrets
from datetime import datetime
import logging
from typing import Dict, Optional, Any

# –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
from .models import User, Portfolio
from .utils import (deserialize_user, serialize_user)
from .currencies import get_currency
from .exceptions import (
    InsufficientFundsError, 
    CurrencyNotFoundError, 
    ApiRequestError,
    ValutaTradeError
)

# –ò–º–ø–æ—Ä—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
from ..infra.settings import SettingsLoader
from ..infra.database import DatabaseManager, DatabaseError
from ..decorators import log_action

# –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ —Å–∏–Ω–≥–ª—Ç–æ–Ω–æ–≤
_settings = SettingsLoader()
_db = DatabaseManager()

CURRENT_USER_ID: Optional[int] = None  # –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

def serialize_portfolio(portfolio: Portfolio) -> Dict:  # –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Üí JSON
    """–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è."""
    return {
        'user_id': portfolio.user_id,  # ID –≤–ª–∞–¥–µ–ª—å—Ü–∞
        'wallets': {
            code: {                  # –ö–∞–∂–¥—ã–π –∫–æ—à–µ–ª—ë–∫
                'currency_code': wallet.currency_code,  # –ö–æ–¥ –≤–∞–ª—é—Ç—ã
                'balance': wallet.balance  # –ë–∞–ª–∞–Ω—Å
            }
            for code, wallet in portfolio.wallets.items()  # –ü–µ—Ä–µ–±–æ—Ä
        }
    }


def deserialize_portfolio(data: Dict[str, Any], user_id: int) -> Portfolio:
    """–î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è –∏–∑ JSON –≤ –æ–±—ä–µ–∫—Ç Portfolio."""
    portfolio = Portfolio(user_id)  # type: Portfolio  # –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è
    
    wallets_data = data.get('wallets', {})  # type: Dict[str, Dict[str, Any]]
    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ—à–µ–ª—å–∫–∞—Ö
    
    for currency_code, wallet_data in wallets_data.items():  # –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ –≤—Å–µ–º –≤–∞–ª—é—Ç–∞–º
        try:
            # –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –ü–†–ò–í–ï–î–ï–ù–ò–ï –¢–ò–ü–ê –ë–ê–õ–ê–ù–°–ê
            balance = float(wallet_data['balance'])  # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏/—á–∏—Å–ª–∞ –≤ float
            
            # –°–û–ó–î–ê–ù–ò–ï –ö–û–®–ï–õ–¨–ö–ê –° –ë–ê–õ–ê–ù–°–û–ú
            portfolio.add_currency(currency_code)  # –°–æ–∑–¥–∞—ë—Ç –∫–æ—à–µ–ª—ë–∫ —Å balance=0.0
            
            # –ü–û–õ–£–ß–ï–ù–ò–ï –ò –ü–†–û–í–ï–†–ö–ê –ö–û–®–ï–õ–¨–ö–ê
            wallet = portfolio.get_wallet(currency_code)
            if wallet is None:
                # –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ö–†–ò–¢–ò–ß–ï–°–ö–û–ô –û–®–ò–ë–ö–ò (–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
                print(f"üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –∫–æ—à–µ–ª—ë–∫ {currency_code} —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω")
                continue  # –ü—Ä–æ–ø—É—Å–∫ —ç—Ç–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞
            
            # –£–°–¢–ê–ù–û–í–ö–ê –†–ï–ê–õ–¨–ù–û–ì–û –ë–ê–õ–ê–ù–°–ê
            wallet.balance = balance  # type: ignore  # –ò–≥–Ω–æ—Ä –¥–ª—è mypy (Optional[Wallet])
            
        except KeyError as e:
            # –û–¢–°–£–¢–°–¢–í–ò–ï –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ì–û –ü–û–õ–Ø 'balance'
            print(f"‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ 'balance' –¥–ª—è –∫–æ—à–µ–ª—å–∫–∞ {currency_code}: {e}")
            continue  # –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞
            
        except ValueError as e:
            # –ù–ï–í–û–ó–ú–û–ñ–ù–û–°–¢–¨ –ü–†–ï–û–ë–†–ê–ó–û–í–ê–¢–¨ balance –í float
            print(f"‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –∫–æ—à–µ–ª—å–∫–∞ {currency_code}: {e}")
            continue  # –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞
            
        except TypeError as e:
            # –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –¢–ò–ü –î–ê–ù–ù–´–•
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ—à–µ–ª—å–∫–∞ {currency_code}: {e}")
            continue  # –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞
    
    return portfolio  # –í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞

def _initialize_user_portfolio(user_id: int) -> None:
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å USD –∫–æ—à–µ–ª—å–∫–æ–º."""
    portfolio = Portfolio(user_id)       # –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è
    portfolio.add_currency('USD')        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π –≤–∞–ª—é—Ç—ã USD
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π —á–µ—Ä–µ–∑ DatabaseManager
    try:
        portfolios = _db.load_portfolios()  # –¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ DatabaseManager
    except DatabaseError as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
        logging.getLogger('database').error(
            f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}"
        )
        raise ValutaTradeError(f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è: {e}") from e
    
    portfolio_data = serialize_portfolio(portfolio)  # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –≤ —Å–ª–æ–≤–∞—Ä—å
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∑–∞—â–∏—Ç–∞ –æ—Ç race condition)
    if not any(p['user_id'] == user_id for p in portfolios):
        portfolios.append(portfolio_data)  # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫
        
        try:
            # –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ DatabaseManager —Å backup –º–µ—Ö–∞–Ω–∏–∑–º–æ–º
            _db.save_portfolios(portfolios)
        except DatabaseError as e:
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
            logging.getLogger('database').error(
                f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}"
            )
            raise ValutaTradeError(f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è: {e}") from e
        

@log_action(action='REGISTER')
def register_user(username: str, password: str) -> int:
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    Args:
        username: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        password: –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
    Returns:
        int: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 
    Raises:
        ValueError: –ï—Å–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–Ω—è—Ç–æ –∏–ª–∏ –ø–∞—Ä–æ–ª—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
        DatabaseError: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
        ValutaTradeError: –ü—Ä–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    Note:
        –î–µ–∫–æ—Ä–∏—Ä–æ–≤–∞–Ω @log_action –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
        –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ª–æ–≥–∏ (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º).
    """
    try:
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ DatabaseManager —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        users = _db.load_users()  # –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    except DatabaseError as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        logging.getLogger('database').error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
        raise ValutaTradeError(f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {e}") from e
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –¢–ó)
    username_lower = username.lower()  # –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    if any(u["username"].lower() == username_lower for u in users):
        raise ValueError(f"–ò–º—è '{username}' —É–∂–µ –∑–∞–Ω—è—Ç–æ")  # –¢–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –¢–ó
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è –ø–æ –¢–ó (–¥–ª–∏–Ω–∞ –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤)
    if len(password) < 4:
        raise ValueError("–ü–∞—Ä–æ–ª—å ‚â•4 —Å–∏–º–≤–æ–ª–∞")  # –¢–æ—á–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –¢–ó
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ user_id: –º–∞–∫—Å–∏–º—É–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö ID + 1 (–∏–ª–∏ 1 –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç)
    user_id = max([u["user_id"] for u in users], default=0) + 1  # –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç ID
    salt = secrets.token_hex(4)  # –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∞—è —Å–æ–ª—å (8 –±–∞–π—Ç –≤ hex —Ñ–æ—Ä–º–∞—Ç–µ)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ User —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø—É—Å—Ç—ã–º —Ö–µ—à–µ–º –ø–∞—Ä–æ–ª—è
    user = User(user_id, username, "", salt, datetime.now())  # OOP-first –ø–æ–¥—Ö–æ–¥
    user.change_password(password)  # –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è: sha256(password + salt)
    
    # –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è User ‚Üí Dict –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    users.append(serialize_user(user))  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
    
    try:
        # –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ DatabaseManager
        _db.save_users(users)  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å backup –º–µ—Ö–∞–Ω–∏–∑–º–æ–º
    except DatabaseError as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        logging.getLogger('database').error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {username}: {e}")
        raise ValutaTradeError(f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {e}") from e
    
    # –°–û–ó–î–ê–ù–ò–ï –ù–ê–ß–ê–õ–¨–ù–û–ì–û –ü–û–†–¢–§–ï–õ–Ø –° USD –ö–û–®–ï–õ–¨–ö–û–ú
    portfolio = create_initial_portfolio(user_id)  # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è —á–µ—Ä–µ–∑ —Ñ–∞–±—Ä–∏–∫—É
    save_portfolio(portfolio)  # –Ø–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è –≤ —Ñ–∞–π–ª —á–µ—Ä–µ–∑ DatabaseManager
    
    return user_id  # –í–æ–∑–≤—Ä–∞—Ç ID –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è CLI

@log_action(action='LOGIN')
def login_user(username: str, password: str) -> None:
    """–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    Args:
        username: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—Ö–æ–¥–∞
        password: –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    Raises:
        ValueError: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–Ω—ã–π
        DatabaseError: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        ValutaTradeError: –ü—Ä–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    Note:
        –î–µ–∫–æ—Ä–∏—Ä–æ–≤–∞–Ω @log_action –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—Ö–æ–¥–∞.
        –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ª–æ–≥–∏ (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º).
    """
    try:
        # –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ DatabaseManager —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        users = _db.load_users()  # –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ JSON —á–µ—Ä–µ–∑ DatabaseManager
    except DatabaseError as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        logging.getLogger('database').error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –≤—Ö–æ–¥–µ: {e}")
        raise ValutaTradeError(f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ: {e}") from e
    
    # –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–º–µ–Ω–∏ (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –ø–æ–∏—Å–∫)
    for user_data in users:  # –ü–µ—Ä–µ–±–æ—Ä –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if user_data["username"].lower() == username.lower():  # Case-insensitive –ø–æ–∏—Å–∫
            user = deserialize_user(user_data)  # Dict ‚Üí User –æ–±—ä–µ–∫—Ç (OOP –ø–∞—Ç—Ç–µ—Ä–Ω)
            
            if user.verify_password(password):  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö–µ—à–∞ –ø–∞—Ä–æ–ª—è
                global CURRENT_USER_ID  # –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å–µ—Å—Å–∏–∏
                CURRENT_USER_ID = user.user_id  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                print(f"–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ '{username}'")  # –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ
                return  # –£—Å–ø–µ—à–Ω—ã–π —Ä–∞–Ω–Ω–∏–π –≤–æ–∑–≤—Ä–∞—Ç
            
            raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å")  # –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å
    
    raise ValueError("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ

def get_current_user() -> User | None:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    Returns:
        User | None: –û–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ None –µ—Å–ª–∏ —Å–µ—Å—Å–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
                    –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
                    
    Raises:
        DatabaseError: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    """
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–µ—Å—Å–∏–∏
    if CURRENT_USER_ID is None:
        return None  # –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏
    
    try:
        # –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ DatabaseManager
        users = _db.load_users()  # –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ JSON —á–µ—Ä–µ–∑ DatabaseManager
    except DatabaseError as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        logging.getLogger('database').error(
            f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ: {e}"
        )
        raise  # –ü—Ä–æ–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–∞–ª—å—à–µ
    
    # –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID —Å—Ä–µ–¥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    for data in users:
        if data["user_id"] == CURRENT_USER_ID:
            return deserialize_user(data)  # –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ –æ–±—ä–µ–∫—Ç User
    
    return None  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π, –Ω–∞–ø—Ä–∏–º–µ—Ä, —É–¥–∞–ª–µ–Ω –∏–∑ —Å–∏—Å—Ç–µ–º—ã)

"""
–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞: —Ä–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è–º–∏.
"""

# –§—É–Ω–∫—Ü–∏–∏ _load_portfolios_from_db –∏ _save_portfolios_to_db —É–¥–∞–ª–µ–Ω—ã,
# —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –Ω–∞–ø—Ä—è–º—É—é –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥—ã DatabaseManager: 
# _db.load_portfolios() –∏ _db.save_portfolios()

# def _load_portfolios_from_db() -> List[Dict]:
#     """–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π —á–µ—Ä–µ–∑ DatabaseManager.
    
#     Returns:
#         –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
#     """
#     return _db.load_portfolios()

# # def save_portfolios(portfolios: List[Dict]) -> None:  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
# #     """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π."""
# #     with open(PORTFOLIOS_FILE, 'w', encoding='utf-8') as f:  # –ó–∞–ø–∏—Å—å
# #         json.dump(portfolios, f, indent=2, ensure_ascii=False)  # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON
# def _save_portfolios_to_db(portfolios: List[Dict]) -> None:
#     """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π —á–µ—Ä–µ–∑ DatabaseManager.
#     Args:
#         portfolios: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
#     """
#     _db.save_portfolios(portfolios)


def load_user(user_id: int) -> Optional[User]:
    """–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É.
    
    Args:
        user_id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        Optional[User]: –û–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
        
    Raises:
        DatabaseError: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    """
    try:
        # –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ DatabaseManager
        users = _db.load_users()  # –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ DatabaseManager
    except DatabaseError as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        logging.getLogger('database').error(
            f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è ID {user_id}: {e}"
        )
        raise  # –ü—Ä–æ–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–∞–ª—å—à–µ
    
    # –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID —Å—Ä–µ–¥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    for u in users:  # –ü–µ—Ä–µ–±–æ—Ä –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if u['user_id'] == user_id:
            return deserialize_user(u)  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä Dict ‚Üí User
    
    return None  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω

def load_portfolio(user_id: int) -> Optional[Portfolio]:
    """–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É.
    
    Args:
        user_id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        Optional[Portfolio]: –û–±—ä–µ–∫—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—è –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
        
    Raises:
        DatabaseError: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
    """
    try:
        # –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π —á–µ—Ä–µ–∑ DatabaseManager
        portfolios = _db.load_portfolios()  # –°–ø–∏—Å–æ–∫ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π —á–µ—Ä–µ–∑ DatabaseManager
    except DatabaseError as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
        logging.getLogger('database').error(
            f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}"
        )
        raise  # –ü—Ä–æ–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–∞–ª—å—à–µ
    
    # –ü–æ–∏—Å–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è –ø–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ä–µ–¥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    for p in portfolios:  # –ü–æ–∏—Å–∫ –ø–æ user_id
        if p['user_id'] == user_id:
            return deserialize_portfolio(p, user_id)  # –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è Dict ‚Üí Portfolio
    
    return None  # –ü–æ—Ä—Ç—Ñ–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω

def get_portfolio(user_id: int) -> Portfolio:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏.
    –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∞–±—Ä–∏–∫—É create_empty_portfolio
    –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è —Å USD.
    Args:
        user_id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    Returns:
        Portfolio: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–ª–∏ –Ω–æ–≤—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å —Å –∫–æ—à–µ–ª—å–∫–æ–º USD
    """
    # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª—å –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    portfolio = load_portfolio(user_id)
    
    if portfolio is None:  # –ï—Å–ª–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–∞–±—Ä–∏–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è
        portfolio = create_empty_portfolio(user_id)
    
    return portfolio  # –í–æ–∑–≤—Ä–∞—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—è (–Ω–æ–≤–æ–≥–æ –∏–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ)

def save_portfolio(portfolio: Portfolio) -> None:
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    Args:
        portfolio: –û–±—ä–µ–∫—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        
    Raises:
        DatabaseError: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
        ValutaTradeError: –ü—Ä–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è
    """
    try:
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π —á–µ—Ä–µ–∑ DatabaseManager
        portfolios = _db.load_portfolios()  # –¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
    except DatabaseError as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
        logging.getLogger('database').error(
            f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}"
        )
        raise ValutaTradeError(f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è: {e}") from e
    
    # –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è –≤ —Å–ª–æ–≤–∞—Ä—å –¥–ª—è JSON
    portfolio_data = serialize_portfolio(portfolio)  # Portfolio ‚Üí Dict
    
    # –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    for i, p in enumerate(portfolios):  # –ü–µ—Ä–µ–±–æ—Ä –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
        if p['user_id'] == portfolio.user_id:  # –ó–∞–º–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è
            portfolios[i] = portfolio_data  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Ä—Ç—Ñ–µ–ª—è
            
            try:
                # –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
                _db.save_portfolios(portfolios)  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ DatabaseManager
            except DatabaseError as e:
                # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
                logging.getLogger('database').error(
                    f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {portfolio.user_id}: {e}"
                )
                raise ValutaTradeError(
                    f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è: {e}"
                ) from e
            return  # –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    
    # –ï—Å–ª–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
    portfolios.append(portfolio_data)  # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫
    
    try:
        # –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π —Å –Ω–æ–≤—ã–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
        _db.save_portfolios(portfolios)  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ DatabaseManager
    except DatabaseError as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
        logging.getLogger('database').error(
            f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {portfolio.user_id}: {e}"
        )
        raise ValutaTradeError(f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è: {e}") from e
    
def create_empty_portfolio(user_id: int) -> Portfolio:
    """
    –§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—É—Å—Ç–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è —Å –±–∞–∑–æ–≤—ã–º USD –∫–æ—à–µ–ª—å–∫–æ–º.
    Args:
        user_id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    Returns:
        Portfolio: –û–±—ä–µ–∫—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—è —Å –∫–æ—à–µ–ª—å–∫–æ–º USD
    Raises:
        TypeError: –ï—Å–ª–∏ user_id –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º
        ValueError: –ü—Ä–∏ –æ—à–∏–±–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∞–ª—é—Ç—ã (–¥—É–±–ª–∏–∫–∞—Ç USD)
    """
    if not isinstance(user_id, int):  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ user_id
        raise TypeError("user_id –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º")
    
    portfolio = Portfolio(user_id)     # –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è
    portfolio.add_currency('USD')      # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π –≤–∞–ª—é—Ç—ã USD
    
    return portfolio                   # –í–æ–∑–≤—Ä–∞—Ç –≥–æ—Ç–æ–≤–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è

def create_initial_portfolio(user_id: int) -> Portfolio:
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –ó–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—É—é _initialize_user_portfolio, —É–±–∏—Ä–∞—è side effects.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∞–±—Ä–∏–∫—É create_empty_portfolio –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è.
    Args:
        user_id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    Returns:
        Portfolio: –û–±—ä–µ–∫—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—è —Å –∫–æ—à–µ–ª—å–∫–æ–º USD
    Raises:
        TypeError: –ï—Å–ª–∏ user_id –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º
        ValueError: –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è USD
    """
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–∞–±—Ä–∏—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è
    portfolio = create_empty_portfolio(user_id)
    
    return portfolio  # –í–æ–∑–≤—Ä–∞—Ç —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

@log_action(action='BUY', verbose=True)
def buy_currency(user_id: int, currency_code: str, amount: float) -> None:
    """–ü–æ–∫—É–ø–∫–∞ –≤–∞–ª—é—Ç—ã –∑–∞ USD.
    Args:
        user_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        currency_code: –ö–æ–¥ –ø–æ–∫—É–ø–∞–µ–º–æ–π –≤–∞–ª—é—Ç—ã
        amount: –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏ –≤ —Ü–µ–ª–µ–≤–æ–π –≤–∞–ª—é—Ç–µ
    Raises:
        ValueError: –ü—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
        CurrencyNotFoundError: –ï—Å–ª–∏ –≤–∞–ª—é—Ç–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
        InsufficientFundsError: –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ USD –Ω–∞ –±–∞–ª–∞–Ω—Å–µ
        ApiRequestError: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å  
    Note:
        –î–µ–∫–æ—Ä–∏—Ä–æ–≤–∞–Ω @log_action –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏.
        –í verbose —Ä–µ–∂–∏–º–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç get_rate() –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫—É—Ä—Å–∞ –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ EXCHANGE_RATES.
    """
    # –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    portfolio = get_portfolio(user_id)
    
    # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞ –≤–∞–ª—é—Ç—ã –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
    currency_code = currency_code.upper()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è
    if amount <= 0:
        raise ValueError("""–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞ ‚Üí
    'amount' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º""")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ –ø—ã—Ç–∞—é—Ç—Å—è –∫—É–ø–∏—Ç—å USD –∑–∞ USD
    if currency_code == "USD":
        raise ValueError("–ù–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å USD –∑–∞ USD")
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –≤–∞–ª—é—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    currency_obj = get_currency(currency_code)  # –ú–æ–∂–µ—Ç –≤—ã–±—Ä–æ—Å–∏—Ç—å CurrencyNotFoundError
    
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫—É—Ä—Å–∞ —á–µ—Ä–µ–∑ get_rate()
    try:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç—ã –∫ USD
        rate, timestamp, source, is_fresh = get_rate(currency_code, "USD")
        
    except (CurrencyNotFoundError, ApiRequestError) as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞
        logging.getLogger('actions').warning(
            f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞ {currency_code}/USD: {e}"
        )
        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ - –±–µ–∑ –∫—É—Ä—Å–∞ –ø–æ–∫—É–ø–∫–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞
        raise  # –ü—Ä–æ–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–∞–ª—å—à–µ
            
    # –ü–æ–ª—É—á–µ–Ω–∏–µ USD –∫–æ—à–µ–ª—å–∫–∞ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ get_portfolio)
    usd_wallet = portfolio.get_wallet("USD")
    
    # –ó–∞—â–∏—Ç–∞ –æ—Ç None - USD –∫–æ—à–µ–ª—ë–∫ –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
    if usd_wallet is None:
        raise ValueError("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: USD –∫–æ—à–µ–ª—ë–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –≤–∞–ª—é—Ç—ã
    target_wallet = portfolio.get_wallet(currency_code)
    if target_wallet is None:
        # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        portfolio.add_currency(currency_code)
        target_wallet = portfolio.get_wallet(currency_code)
    
    # –ó–∞—â–∏—Ç–∞ –æ—Ç None –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞
    if target_wallet is None:
        raise ValueError(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ—à–µ–ª—ë–∫ {currency_code}")
    
    # –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–∫—É–ø–∫–∏ –≤ USD —á–µ—Ä–µ–∑ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫—É—Ä—Å
    usd_cost = amount * rate
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ USD –∫–æ—à–µ–ª—å–∫–µ
    if usd_wallet.balance < usd_cost:
        raise InsufficientFundsError(
            available=usd_wallet.balance,  # –î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å USD
            required=usd_cost,             # –¢—Ä–µ–±—É–µ–º–∞—è —Å—É–º–º–∞ USD
            code="USD"                     # –ö–æ–¥ –≤–∞–ª—é—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–∏ (USD)
        )
    
    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–∫—É–ø–∫–∏
    usd_wallet.withdraw(usd_cost)
    target_wallet.deposit(amount)
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫—É—Ä—Å–µ –≤ –¥–µ–π—Å—Ç–≤–∏—è—Ö
    actions_logger = logging.getLogger('actions')
    actions_logger.info(
        f"–ö—É—Ä—Å {currency_code}/USD: {rate:.6f}, –∏—Å—Ç–æ—á–Ω–∏–∫: {source}",
        extra={
            'rate': rate,
            'rate_source': source,
            'rate_fresh': is_fresh,
            'rate_timestamp': timestamp,
            'currency_name': currency_obj.name,
            'usd_cost': usd_cost
        }
    )
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è
    save_portfolio(portfolio)


@log_action(action='SELL', verbose=True)
def sell_currency(user_id: int, currency_code: str, amount: float) -> None:
    """–ü—Ä–æ–¥–∞–∂–∞ –≤–∞–ª—é—Ç—ã: —Å–ø–∏—Å–∞—Ç—å —Ü–µ–ª–µ–≤—É—é, –Ω–∞—á–∏—Å–ª–∏—Ç—å USD.
    Args:
        user_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        currency_code: –ö–æ–¥ –ø—Ä–æ–¥–∞–≤–∞–µ–º–æ–π –≤–∞–ª—é—Ç—ã
        amount: –°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂–∏ –≤ —Ü–µ–ª–µ–≤–æ–π –≤–∞–ª—é—Ç–µ  
    Raises:
        ValueError: –ü—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
        CurrencyNotFoundError: –ï—Å–ª–∏ –≤–∞–ª—é—Ç–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
        InsufficientFundsError: –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏
        ApiRequestError: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å   
    Note:
        –î–µ–∫–æ—Ä–∏—Ä–æ–≤–∞–Ω @log_action –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏.
        –í verbose —Ä–µ–∂–∏–º–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç get_rate() –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫—É—Ä—Å–∞ –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ EXCHANGE_RATES.
    """
    # –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    portfolio = get_portfolio(user_id)
    
    # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞ –≤–∞–ª—é—Ç—ã –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
    currency_code = currency_code.upper()
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è: —Å—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π
    if amount <= 0:
        raise ValueError("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π")
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è: –Ω–µ–ª—å–∑—è –ø—Ä–æ–¥–∞—Ç—å USD (—ç—Ç–æ –±–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞)
    if currency_code == 'USD':
        raise ValueError("–ù–µ–ª—å–∑—è –ø—Ä–æ–¥–∞—Ç—å USD (—ç—Ç–æ –±–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞)")
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –≤–∞–ª—é—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    currency_obj = get_currency(currency_code)  # –ú–æ–∂–µ—Ç –≤—ã–±—Ä–æ—Å–∏—Ç—å CurrencyNotFoundError
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫—É—Ä—Å–∞ —á–µ—Ä–µ–∑ get_rate()
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫—É—Ä—Å–∞ —á–µ—Ä–µ–∑ get_rate()
    try:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç—ã –∫ USD –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –≤—ã—Ä—É—á–∫–∏
        rate, timestamp, source, is_fresh = get_rate(currency_code, "USD")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –∫—É—Ä—Å–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó4
        if not is_fresh:
            actions_logger = logging.getLogger('actions')
            actions_logger.warning(
                f"–ö—É—Ä—Å {currency_code}/USD —É—Å—Ç–∞—Ä–µ–ª (–æ–±–Ω–æ–≤–ª—ë–Ω: {timestamp})",
                extra={
                    'currency': currency_code,
                    'timestamp': timestamp,
                    'source': source,
                    'suggestion': "–í—ã–ø–æ–ª–Ω–∏—Ç–µ update-rates –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"
                }
            )
            # –ü–æ –¢–ó: "Core —á–µ—Å—Ç–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏"
            print(f"‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –∫—É—Ä—Å {currency_code} –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º (–æ–±–Ω–æ–≤–ª—ë–Ω: {timestamp})")
            
    except (CurrencyNotFoundError, ApiRequestError) as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞
        logging.getLogger('actions').warning(
            f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞ {currency_code}/USD: {e}"
        )
        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ - –±–µ–∑ –∫—É—Ä—Å–∞ –ø—Ä–æ–¥–∞–∂–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞
        raise  # –ü—Ä–æ–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–∞–ª—å—à–µ
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏
    target_wallet = portfolio.get_wallet(currency_code)
    
    # –ó–∞—â–∏—Ç–∞ –æ—Ç None: –∫–æ—à–µ–ª—ë–∫ –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏
    if target_wallet is None:
        raise ValueError(f"–£ –≤–∞—Å –Ω–µ—Ç –∫–æ—à–µ–ª—å–∫–∞ '{currency_code}'. "
                         f"–î–æ–±–∞–≤—å—Ç–µ –≤–∞–ª—é—Ç—É: –æ–Ω–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–µ.")
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ USD –∫–æ—à–µ–ª—å–∫–∞ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ get_portfolio)
    usd_wallet = portfolio.get_wallet('USD')
    
    # –ó–∞—â–∏—Ç–∞ –æ—Ç None –¥–ª—è mypy (–∫–æ—à–µ–ª—ë–∫ USD –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å)
    if usd_wallet is None:
        raise ValueError("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: USD –∫–æ—à–µ–ª—ë–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å–∞ —Ü–µ–ª–µ–≤–æ–π –≤–∞–ª—é—Ç—ã
    if target_wallet.balance < amount:
        raise InsufficientFundsError(
            available=target_wallet.balance,  # –î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å
            required=amount,                  # –¢—Ä–µ–±—É–µ–º–∞—è —Å—É–º–º–∞
            code=currency_code                # –ö–æ–¥ –≤–∞–ª—é—Ç—ã
        )
    
    # –†–∞—Å—á—ë—Ç –≤—ã—Ä—É—á–∫–∏ –≤ USD —á–µ—Ä–µ–∑ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫—É—Ä—Å
    usd_income = amount * rate
    
    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–¥–∞–∂–∏
    target_wallet.withdraw(amount)
    usd_wallet.deposit(usd_income)
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫—É—Ä—Å–µ –∏ –≤—ã—Ä—É—á–∫–µ
    actions_logger = logging.getLogger('actions')
    actions_logger.info(
        f"–ö—É—Ä—Å –ø—Ä–æ–¥–∞–∂–∏ {currency_code}/USD: {rate:.6f}, –≤—ã—Ä—É—á–∫–∞: {usd_income:.2f} USD",
        extra={
            'rate': rate,
            'rate_source': source,
            'rate_fresh': is_fresh,
            'rate_timestamp': timestamp,
            'currency_name': currency_obj.name,
            'usd_income': usd_income,
            'sold_amount': amount
        }
    )
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è
    save_portfolio(portfolio)

def get_rate(from_currency: str, to_currency: str) -> tuple[float, str, str, bool]:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö.
    Args:
        from_currency: –ò—Å—Ö–æ–¥–Ω–∞—è –≤–∞–ª—é—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "USD")
        to_currency: –¶–µ–ª–µ–≤–∞—è –≤–∞–ª—é—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "BTC") 
    Returns:
        tuple: (–∫—É—Ä—Å, timestamp, –∏—Å—Ç–æ—á–Ω–∏–∫, is_fresh)
        - float: –ü—Ä—è–º–æ–π –∫—É—Ä—Å –æ–±–º–µ–Ω–∞
        - str: –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–ª–∏ "N/A"
        - str: –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, "CoinGecko", "ExchangeRate-API", "Fallback")
        - bool: True –µ—Å–ª–∏ –∫—É—Ä—Å —Å–≤–µ–∂–∏–π, False –µ—Å–ª–∏ —É—Å—Ç–∞—Ä–µ–ª 
    Raises:
        CurrencyNotFoundError: –ï—Å–ª–∏ –æ–¥–Ω–∞ –∏–∑ –≤–∞–ª—é—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
        ApiRequestError: –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞ –Ω–æ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
        DatabaseError: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤
        ValutaTradeError: –ü—Ä–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞
    """
    # 1. –í–ê–õ–ò–î–ê–¶–ò–Ø –ö–û–î–û–í –í–ê–õ–Æ–¢ –ß–ï–†–ï–ó get_currency()
    try:
        from_curr_obj = get_currency(from_currency)
        to_curr_obj = get_currency(to_currency)
    except CurrencyNotFoundError:
        raise
    
    from_code = from_curr_obj.code
    to_code = to_curr_obj.code
    pair = f"{from_code}_{to_code}"
    
        # 2. –ü–û–ü–´–¢–ö–ê –ü–û–õ–£–ß–ò–¢–¨ –ö–£–†–° –ò–ó PARSER SERVICE
    try:
        from valutatrade_hub.parser_service import RatesCache
        
        cache = RatesCache("data/rates.json")
        rate_info = cache.get_rate(from_code, to_code)
        
        if rate_info is not None:
            source_display = f"Parser Service ({rate_info.source})"
            
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
            logger = logging.getLogger('rates')
            if rate_info.is_fresh:
                logger.debug(f"–°–≤–µ–∂–∏–π –∫—É—Ä—Å {pair}: {rate_info.rate} –æ—Ç {rate_info.source}")
            else:
                # ‚≠ê‚≠ê‚≠ê –í–û–¢ –¢–£–¢ –î–û–ë–ê–í–õ–Ø–ï–ú –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –û–ë–ù–û–í–ò–¢–¨ ‚≠ê‚≠ê‚≠ê
                logger.warning(
                    f"–£—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫—É—Ä—Å {pair} –æ—Ç {rate_info.source}. "
                    f"–û–±–Ω–æ–≤–∏—Ç–µ —á–µ—Ä–µ–∑: python -m valutatrade_hub.cli update-rates"
                )
            
            return (
                rate_info.rate,
                rate_info.updated_at,
                source_display,
                rate_info.is_fresh
            )
            
    except ImportError:
        # Parser Service –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - —Ç–∏—Ö–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        pass
    except Exception as e:
        logging.getLogger('rates').warning(f"–û—à–∏–±–∫–∞ Parser Service –¥–ª—è {pair}: {type(e).__name__}")
    
    # 3. FALLBACK –ù–ê –°–¢–ê–†–£–Æ –õ–û–ì–ò–ö–£ (–î–õ–Ø –û–ë–†–ê–¢–ù–û–ô –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò)
    logger = logging.getLogger('rates')
    
    try:
        rates = _db.load_rates()
        
        if pair in rates:
            rate_data = rates[pair]
            rate_value = rate_data.get('rate')
            timestamp = rate_data.get('updated_at', 'N/A')
            
            if rate_value is not None and timestamp != 'N/A':
                is_fresh = is_rate_fresh(pair, timestamp)
                source = "rates.json (legacy)"
                
                if not is_fresh:
                    source = "rates.json (legacy, stale)"
                    logger.info(f"–£—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫—É—Ä—Å –∏–∑ legacy —Ñ–∞–π–ª–∞: {pair}")
                
                return (float(rate_value), timestamp, source, is_fresh)
                
    except DatabaseError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ legacy –∫—É—Ä—Å–æ–≤ –¥–ª—è {pair}: {e}")
    except Exception as e:
        logger.debug(f"–û—à–∏–±–∫–∞ legacy fallback –¥–ª—è {pair}: {type(e).__name__}")
    
        # 4. FINAL FALLBACK: –ì–ï–ù–ï–†–ê–¶–ò–Ø –†–ï–ê–õ–ò–°–¢–ò–ß–ù–û–ì–û –ö–£–†–°–ê
    logger.info(f"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –∫—É—Ä—Å–∞ –¥–ª—è {pair}")
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –∫—É—Ä—Å–∞
    fallback_rate = _generate_realistic_rate(pair)
    
    return (
        fallback_rate,
        "N/A",
        "Fallback (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –∫—É—Ä—Å–∞)",
        False
    )

def generate_test_rates(test_scenario: str = "mixed") -> None:
    """
    –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è rates.json —Å —Ä–∞–∑–Ω—ã–º–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏.
    Args:
        test_scenario: –°—Ü–µ–Ω–∞—Ä–∏–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö ("mixed", "all_fresh", 
                      "all_stale", "invalid", "empty")        
    Returns:
        None: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ rates.json —á–µ—Ä–µ–∑ DatabaseManager
    Raises:
        ValueError: –ü—Ä–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        DatabaseError: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤
        ValutaTradeError: –ü—Ä–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    """
    from datetime import datetime, timedelta
    
    # –ë–∞–∑–æ–≤—ã–µ –≤–∞–ª—é—Ç–Ω—ã–µ –ø–∞—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    currency_pairs = ["EUR_USD", "BTC_USD", "RUB_USD", "ETH_USD", "BTC_EUR"]
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–æ–≤–∞—Ä—è –¥–ª—è rates.json
    test_rates = {}
    current_time = datetime.now()
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è timestamp –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
    if test_scenario == "all_fresh":
        # –í—Å–µ –∫—É—Ä—Å—ã —Å–≤–µ–∂–∏–µ (–æ–±–Ω–æ–≤–ª–µ–Ω—ã 1 –º–∏–Ω—É—Ç—É –Ω–∞–∑–∞–¥)
        timestamp = current_time - timedelta(minutes=1)
        for pair in currency_pairs:
            test_rates[pair] = {
                "rate": _generate_realistic_rate(pair),
                "updated_at": timestamp.isoformat()
            }
    
    elif test_scenario == "all_stale":
        # –í—Å–µ –∫—É—Ä—Å—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ (–æ–±–Ω–æ–≤–ª–µ–Ω—ã 2 –¥–Ω—è –Ω–∞–∑–∞–¥)
        timestamp = current_time - timedelta(days=2)
        for pair in currency_pairs:
            test_rates[pair] = {
                "rate": _generate_realistic_rate(pair),
                "updated_at": timestamp.isoformat()
            }
    
    elif test_scenario == "mixed":
        # –°–º–µ—à–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: 2 —Å–≤–µ–∂–∏—Ö, 3 —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö
        fresh_time = current_time - timedelta(minutes=1)
        stale_time = current_time - timedelta(days=2)
        
        for i, pair in enumerate(currency_pairs):
            timestamp = fresh_time if i < 2 else stale_time
            test_rates[pair] = {
                "rate": _generate_realistic_rate(pair),
                "updated_at": timestamp.isoformat()
            }
    
    elif test_scenario == "invalid":
        # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã timestamp –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
        for pair in currency_pairs:
            test_rates[pair] = {
                "rate": _generate_realistic_rate(pair),
                "updated_at": "2025-13-45T99:99:99"  # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            }
    
    elif test_scenario == "empty":
        # –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª rates.json
        test_rates = {}
    
    else:
        raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: {test_scenario}")
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if test_scenario != "empty":
        test_rates["source"] = "TestDataGenerator"
        test_rates["last_refresh"] = current_time.isoformat()
        test_rates["test_scenario"] = test_scenario
    
    try:
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ DatabaseManager —Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º backup
        _db.save_rates(test_rates)
    except DatabaseError as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤
        logging.getLogger('database').error(
            f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫—É—Ä—Å–æ–≤ –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è {test_scenario}: {e}"
        )
        raise ValutaTradeError(
            f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {e}"
        ) from e
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    print("‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —á–µ—Ä–µ–∑ DatabaseManager")
    print(f"   –°—Ü–µ–Ω–∞—Ä–∏–π: {test_scenario}")
    print(f"   –ó–∞–ø–∏—Å–µ–π –∫—É—Ä—Å–æ–≤: {len([k for k in test_rates.keys() if '_' in k])}")

def _generate_realistic_rate(currency_pair: str) -> float:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç—ã.
    
    Args:
        currency_pair: –í–∞–ª—é—Ç–Ω–∞—è –ø–∞—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "EUR_USD"
        
    Returns:
        float: –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∫—É—Ä—Å –æ–±–º–µ–Ω–∞
    """
    # –°–û–ë–°–¢–í–ï–ù–ù–´–ô –°–õ–û–í–ê–†–¨ –†–ï–ê–õ–ò–°–¢–ò–ß–ù–´–• –ö–£–†–°–û–í
    REALISTIC_BASE_RATES = {
        'BTC': 59337.21,   # Bitcoin –∫ USD
        'ETH': 3720.00,    # Ethereum –∫ USD
        'EUR': 1.0786,     # Euro –∫ USD
        'USD': 1.0,        # –ë–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞
        'RUB': 0.01016,    # Ruble –∫ USD
        'GBP': 1.2593,     # Pound –∫ USD
        'JPY': 0.0067,     # Yen –∫ USD
        'CNY': 0.1387,     # Yuan –∫ USD
        'SOL': 145.12      # Solana –∫ USD
    }
    
    try:
        # –ü–∞—Ä—Å–∏–Ω–≥ –≤–∞–ª—é—Ç–Ω–æ–π –ø–∞—Ä—ã
        from_curr, to_curr = currency_pair.split("_")
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –∏–∑ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è
        from_rate = REALISTIC_BASE_RATES.get(from_curr, 1.0)
        to_rate = REALISTIC_BASE_RATES.get(to_curr, 1.0)
        
        # –†–∞—Å—á–µ—Ç –∫—É—Ä—Å–∞: to_currency / from_currency
        if from_rate == 0:
            return 0.0  # –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
        return round(to_rate / from_rate, 6)  # –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
    
    except (ValueError, KeyError):
        # Fallback: —Å–ª—É—á–∞–π–Ω—ã–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∫—É—Ä—Å
        import random
        return round(random.uniform(0.5, 2.5), 4)

def _save_rates_to_file(rates_data: dict) -> None:
    """
    –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –≤ rates.json.
    
    Args:
        rates_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∫—É—Ä—Å–æ–≤
    """
    from pathlib import Path
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ data –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    data_dir = Path("data")
    data_dir.mkdir(exist_ok=True)
    
    # –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É rates.json
    rates_file = data_dir / "rates.json"
    
    try:
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ JSON —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        with open(rates_file, 'w', encoding='utf-8') as f:
            json.dump(rates_data, f, indent=2, ensure_ascii=False)
        
        print(f"‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ {rates_file}")
        print(f"   –°—Ü–µ–Ω–∞—Ä–∏–π: {rates_data.get('test_scenario', 'N/A')}")
        print(f"   –ó–∞–ø–∏—Å–µ–π –∫—É—Ä—Å–æ–≤: {len([k for k in rates_data.keys() 
                                      if not k.startswith('_')])}")
    
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è rates.json: {e}")
        raise

def is_rate_fresh(currency_pair: str, timestamp: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç—ã —á–µ—Ä–µ–∑ Parser Service.
    """
    try:
        # –õ–ï–ù–ò–í–´–ô –ò–ú–ü–û–†–¢ - —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å
        from valutatrade_hub.parser_service import RatesCache
        cache = RatesCache("data/rates.json")
        return cache.is_fresh(currency_pair, timestamp)
    except Exception as e:
        logging.getLogger('rates').warning(
            f"Parser Service –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–µ–∂–µ—Å—Ç–∏: {type(e).__name__}"
        )
        return False
    
# def _fetch_rate_from_api(pair: str) -> float:
#     """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ API.
#     –í –±—É–¥—É—â–µ–º –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ Parser Service
#     Args:
#         pair: –í–∞–ª—é—Ç–Ω–∞—è –ø–∞—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "EUR_USD"
#     Returns:
#         float: –ó–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç—ã
#     Raises:
#         ApiRequestError: –ò–º–∏—Ç–∞—Ü–∏—è –æ—à–∏–±–∫–∏ API (–∑–∞–≥–ª—É—à–∫–∞)
#     """
#     from .exceptions import ApiRequestError
    
#     # –ó–ê–ì–õ–£–®–ö–ê: –∏–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ –≤–Ω–µ—à–Ω–µ–º—É API
#     # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Parser Service
#     raise ApiRequestError("API –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ (–∑–∞–≥–ª—É—à–∫–∞)")

